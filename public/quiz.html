<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI Revision Quiz</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b1220; color:#fff; margin:0; padding:20px; }
    .box { max-width: 980px; margin: 0 auto; background:#111a2e; padding:20px; border-radius:12px; }
    h1 { margin: 0 0 8px; }
    .meta { opacity:.85; margin-bottom: 10px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    button { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:600; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    input[type="file"] { padding:6px; }
    input[type="number"] { width: 90px; padding:8px; border-radius:10px; border:0; }
    .status { margin-top:12px; padding:10px; border-radius:10px; background: rgba(255,255,255,.08); }
    .status.ok { background: rgba(56,211,159,.15); }
    .status.bad { background: rgba(255,107,107,.15); }
    .card { margin-top: 14px; padding: 14px; border-radius: 12px; background: rgba(255,255,255,.06); }
    .qmeta { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; opacity:.9; }
    .options label { display:block; padding:10px; border-radius:10px; background: rgba(255,255,255,.06); margin:10px 0; cursor:pointer; }
    .options input { margin-right: 10px; }
    .feedback { margin-top:10px; font-weight:700; }
    .feedback.ok { color:#38d39f; }
    .feedback.bad { color:#ff6b6b; }
    .tiny { font-size: .92rem; opacity:.85; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background: rgba(255,255,255,.10); }
  </style>
</head>
<body>
  <div class="box">
    <h1>AI Revision Quiz</h1>
    <div class="meta">Select a PDF and page range. Press get questions to start generating or to generate more questions. Click reset to upload another PDF.</div>

    <div class="card">
      <div class="row">
        <input type="file" id="pdfFile" accept="application/pdf">

        <label class="pill">Start page
          <input type="number" id="startPage" value="1" min="1">
        </label>

        <label class="pill">End page
          <input type="number" id="endPage" value="5" min="1">
        </label>

        <button id="getBtn">Get Questions</button>
        <button id="startBtn" disabled>Start Quiz</button>
        <button id="resetBtn">Reset</button>
      </div>

      <div id="status" class="status">Status: Waiting for PDF.</div>
      <div id="info" class="tiny"></div>
    </div>

    <div class="card" id="quizCard" style="display:none">
      <div class="qmeta">
        <div id="progress"></div>
        <div id="score"></div>
      </div>

      <h3 id="prompt" style="margin-top:10px"></h3>
      <div id="options" class="options"></div>

      <div class="row">
        <button id="checkBtn">Check</button>
        <button id="nextBtn" disabled>Next</button>
      </div>

      <div id="feedback" class="feedback"></div>
    </div>
  </div>

<script>
  // ----------------------------
  // Session ID
  // ----------------------------
  function getSessionId() {
    const key = "ai_quiz_session_id";
    let sid = localStorage.getItem(key);
    if (!sid) {
      sid = "sid_" + Math.random().toString(16).slice(2) + "_" + Date.now();
      localStorage.setItem(key, sid);
    }
    return sid;
  }
  const SESSION_ID = getSessionId();

  // ----------------------------
  // State
  // ----------------------------
  let BANK = [];
  let idx = 0;
  let score = 0;

  const $ = (id) => document.getElementById(id);

  function setStatus(msg, kind="") {
    const el = $("status");
    el.textContent = "Status: " + msg;
    el.className = "status " + (kind || "");
  }

  function setInfo(msg="") {
    $("info").textContent = msg;
  }

  function showQuiz(show) {
    $("quizCard").style.display = show ? "block" : "none";
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
    }[m]));
  }

  // ----------------------------
  // Generate / append questions
  // ----------------------------
  $("getBtn").addEventListener("click", async () => {
    const file = $("pdfFile").files[0];
    if (!file) {
      alert("Please select a PDF first.");
      setStatus("No PDF selected.", "bad");
      return;
    }

    const startPage = $("startPage").value;
    const endPage = $("endPage").value;

    $("getBtn").disabled = true;
    setStatus("Generating questionsâ€¦ please wait.");

    const previousCount = BANK.length;

    const fd = new FormData();
    fd.append("session_id", SESSION_ID);
    fd.append("start_page", startPage);
    fd.append("end_page", endPage);
    fd.append("pdf", file);

    try {
      const res = await fetch("/api/next-20", { method: "POST", body: fd });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: "Server error" }));
        console.error(err);
        setStatus(err.error || "Server error.", "bad");
        return;
      }

      const data = await res.json();
      BANK = data.mcq || BANK;

      const added = data.added ?? (BANK.length - previousCount);
      setStatus(`Added ${added} new questions.`, "ok");
      setInfo(`Total questions available: ${BANK.length}`);

      $("startBtn").disabled = BANK.length === 0;

      // ðŸ”‘ KEY FIX: do NOT reset idx
      // If user already finished old questions, jump to first new one
      if (previousCount > 0 && idx >= previousCount) {
        renderQuestion();
      }

    } catch (e) {
      console.error(e);
      setStatus("Network error.", "bad");
    } finally {
      $("getBtn").disabled = false;
    }
  });

  // ----------------------------
  // Reset
  // ----------------------------
  $("resetBtn").addEventListener("click", async () => {
    const fd = new FormData();
    fd.append("session_id", SESSION_ID);
    try { await fetch("/api/reset", { method: "POST", body: fd }); } catch {}

    BANK = [];
    idx = 0;
    score = 0;
    showQuiz(false);
    $("startBtn").disabled = true;
    setStatus("Reset complete.", "ok");
    setInfo("");
  });

  // ----------------------------
  // Quiz flow
  // ----------------------------
  $("startBtn").addEventListener("click", () => {
    if (!BANK.length) return;
    renderQuestion();
    showQuiz(true);
  });

  function renderQuestion() {
    $("nextBtn").disabled = true;
    $("feedback").textContent = "";
    $("feedback").className = "feedback";

    const total = BANK.length;
    const q = BANK[idx];

    $("progress").textContent = `Question ${idx + 1} / ${total}`;
    $("score").textContent = `Score ${score} / ${total}`;
    $("prompt").textContent = q.prompt;

    const opts = q.options || {};
    const optionsEl = $("options");
    optionsEl.innerHTML = "";

    ["A","B","C","D"].forEach(letter => {
      const label = document.createElement("label");
      label.innerHTML = `
        <input type="radio" name="ans" value="${letter}">
        <strong>${letter})</strong> ${escapeHtml(opts[letter] || "")}
      `;
      optionsEl.appendChild(label);
    });
  }

  $("checkBtn").addEventListener("click", () => {
    const picked = document.querySelector('input[name="ans"]:checked');
    if (!picked) { alert("Select an option."); return; }

    const correct = BANK[idx].answer;
    const ok = picked.value === correct;
    if (ok) score++;

    $("feedback").textContent = ok ? "Correct!" : `Incorrect. Correct answer: ${correct}`;
    $("feedback").className = "feedback " + (ok ? "ok" : "bad");
    $("nextBtn").disabled = false;
  });

  $("nextBtn").addEventListener("click", () => {
    if (idx < BANK.length - 1) {
      idx++;
      renderQuestion();
    } else {
      alert(`End reached. Score: ${score} / ${BANK.length}`);
    }
  });
</script>
</body>
</html>

