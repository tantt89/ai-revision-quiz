<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI Revision Quiz (Next 20)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b1220; color:#fff; margin:0; padding:20px; }
    .box { max-width: 920px; margin: 0 auto; background:#111a2e; padding:20px; border-radius:12px; }
    h1 { margin: 0 0 8px; }
    .meta { opacity:.85; margin-bottom: 8px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    button { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:600; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .status { margin-top:12px; padding:10px; border-radius:10px; background: rgba(255,255,255,.08); }
    .status.ok { background: rgba(56,211,159,.15); }
    .status.bad { background: rgba(255,107,107,.15); }
    .card { margin-top: 14px; padding: 14px; border-radius: 12px; background: rgba(255,255,255,.06); }
    .qmeta { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; opacity:.9; }
    .options label { display:block; padding:10px; border-radius:10px; background: rgba(255,255,255,.06); margin:10px 0; cursor:pointer; }
    .options input { margin-right: 10px; }
    .feedback { margin-top:10px; font-weight:700; }
    .feedback.ok { color:#38d39f; }
    .feedback.bad { color:#ff6b6b; }
    .tiny { font-size: .92rem; opacity:.85; }
    code { background: rgba(255,255,255,.10); padding: 2px 6px; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="box">
    <h1>AI Revision Quiz</h1>
    <div class="meta">Upload one PDF, then click <b>Next 20</b> as many times as you want.</div>
    <div class="tiny">If you change PDF midway, click <b>Reset</b> first.</div>

    <div class="card">
      <div class="row">
        <input type="file" id="pdfFile" accept="application/pdf">
        <button id="next20Btn">Next 20</button>
        <button id="startBtn" disabled>Start Quiz</button>
        <button id="resetBtn">Reset</button>
      </div>
      <div id="status" class="status">Status: Waiting for PDF.</div>
      <div class="tiny" id="bankInfo"></div>
    </div>

    <div class="card" id="quizCard" style="display:none">
      <div class="qmeta">
        <div id="progress">Question</div>
        <div id="score">Score</div>
      </div>

      <h3 id="prompt" style="margin-top:10px"></h3>
      <div id="options" class="options"></div>

      <div class="row">
        <button id="checkBtn">Check</button>
        <button id="nextBtn" disabled>Next</button>
      </div>

      <div id="feedback" class="feedback"></div>
    </div>
  </div>

<script>
  // ----------------------------
  // Session ID (per user)
  // ----------------------------
  function getSessionId() {
    const key = "ai_quiz_session_id";
    let sid = localStorage.getItem(key);
    if (!sid) {
      sid = "sid_" + Math.random().toString(16).slice(2) + "_" + Date.now();
      localStorage.setItem(key, sid);
    }
    return sid;
  }
  const SESSION_ID = getSessionId();

  // ----------------------------
  // State
  // ----------------------------
  let BANK = [];   // all MCQ accumulated
  let idx = 0;
  let score = 0;

  const $ = (id) => document.getElementById(id);

  function setStatus(msg, kind="") {
    const el = $("status");
    el.textContent = "Status: " + msg;
    el.className = "status " + (kind || "");
  }

  function updateBankInfo(extra="") {
    $("bankInfo").textContent = `Current bank: ${BANK.length} MCQ. ${extra}`.trim();
  }

  function showQuiz(show) {
    $("quizCard").style.display = show ? "block" : "none";
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
    }[m]));
  }

  // ----------------------------
  // Next 20
  // ----------------------------
  $("next20Btn").addEventListener("click", async () => {
    const file = $("pdfFile").files && $("pdfFile").files[0];
    if (!file) {
      alert("Please select a PDF first.");
      setStatus("No PDF selected.", "bad");
      return;
    }

    $("next20Btn").disabled = true;
    setStatus("Generating next 20… please wait.", "");

    const fd = new FormData();
    fd.append("session_id", SESSION_ID);
    fd.append("pdf", file);

    try {
      const res = await fetch("/api/next-20", { method: "POST", body: fd });

      if (!res.ok) {
        const txt = await res.text();
        console.error("Server error:", txt);
        setStatus("Server error. See Console (F12).", "bad");
        alert("Server error. Open DevTools (F12) → Console.");
        return;
      }

      const data = await res.json();
      BANK = data.mcq || [];
      const added = data.added ?? 0;

      setStatus(`Added ${added} new questions.`, "ok");
      updateBankInfo();
      $("startBtn").disabled = BANK.length === 0;

    } catch (e) {
      console.error(e);
      setStatus("Network error. Try refresh.", "bad");
    } finally {
      $("next20Btn").disabled = false;
    }
  });

  // ----------------------------
  // Reset
  // ----------------------------
  $("resetBtn").addEventListener("click", async () => {
    const fd = new FormData();
    fd.append("session_id", SESSION_ID);

    try {
      await fetch("/api/reset", { method: "POST", body: fd });
    } catch {}
    BANK = [];
    idx = 0;
    score = 0;
    showQuiz(false);
    $("startBtn").disabled = true;
    updateBankInfo("Reset complete.");
    setStatus("Reset complete. Upload a PDF and click Next 20.", "ok");
  });

  // ----------------------------
  // Quiz flow
  // ----------------------------
  $("startBtn").addEventListener("click", () => {
    if (!BANK.length) return;
    idx = 0;
    score = 0;
    render();
    showQuiz(true);
  });

  function render() {
    $("nextBtn").disabled = true;
    $("feedback").textContent = "";
    $("feedback").className = "feedback";

    const total = BANK.length;
    const q = BANK[idx];

    $("progress").textContent = `Question ${idx + 1} / ${total}`;
    $("score").textContent = `Score ${score} / ${total}`;
    $("prompt").textContent = q?.prompt || "(no prompt)";

    const opts = q?.options || {};
    const optionsEl = $("options");
    optionsEl.innerHTML = "";

    ["A","B","C","D"].forEach(letter => {
      const text = opts[letter] ?? "";
      const label = document.createElement("label");
      label.innerHTML = `
        <input type="radio" name="ans" value="${letter}">
        <strong>${letter})</strong> ${escapeHtml(text)}
      `;
      optionsEl.appendChild(label);
    });
  }

  $("checkBtn").addEventListener("click", () => {
    if (!BANK.length) return;

    const picked = document.querySelector('input[name="ans"]:checked');
    if (!picked) { alert("Please select an option."); return; }

    const correct = BANK[idx].answer;
    const ok = picked.value === correct;
    if (ok) score++;

    $("feedback").textContent = ok ? "Correct!" : `Incorrect. Correct answer: ${correct}`;
    $("feedback").className = "feedback " + (ok ? "ok" : "bad");
    $("nextBtn").disabled = false;
  });

  $("nextBtn").addEventListener("click", () => {
    if (idx < BANK.length - 1) {
      idx++;
      render();
    } else {
      alert(`Done! Final score: ${score} / ${BANK.length}`);
      showQuiz(false);
    }
  });

  // Initial UI
  updateBankInfo();
</script>
</body>
</html>
